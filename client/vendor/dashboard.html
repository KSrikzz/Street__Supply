<!DOCTYPE html>
<html>
<head>
  <title>Vendor Dashboard</title>
  <link rel="stylesheet" href="../css/style.css" />
  <style>
    .hidden { display: none; }
    .modal {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex; justify-content: center; align-items: center;
    }
    .modal-content {
      background: #fff; padding: 20px;
      border-radius: 10px; width: 300px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Available Products from Sellers</h2>
    <div id="productList"></div>
  </div>

  <!-- Order Form Modal -->
  <div id="orderForm" class="modal hidden">
    <div class="modal-content">
      <h3>Place Order</h3>
      <input type="text" id="vendorName" placeholder="Your Name" />
      <input type="text" id="address" placeholder="Delivery Address" />
      <input type="text" id="phone" placeholder="Phone Number" />
      <input type="date" id="deliveryDate" />
      <input type="number" id="orderQuantity" placeholder="Quantity" />
      <input type="hidden" id="productId" />
      <input type="hidden" id="sellerId" />
      <button onclick="submitOrder()">Submit Order</button>
      <button onclick="closeForm()">Cancel</button>
    </div>
  </div>

  <script>
document.addEventListener("DOMContentLoaded", async () => {
  const token = localStorage.getItem("token");

  if (!token) {
    alert("You must log in first.");
    window.location.href = "../vendorLogin.html";
    return;
  }

  try {
    const res = await fetch("http://localhost:5000/api/products/my-products", {
      headers: { Authorization: `Bearer ${token}` } // ✅ auth header
    });

    const products = await res.json();
    const productList = document.getElementById("productList");
    productList.innerHTML = "";

    products.forEach(product => {
      const li = document.createElement("li");
      li.innerHTML = `
        ${product.name} - ₹${product.price} (Qty: ${product.quantity})
        <form class="orderForm">
          <input type="text" name="buyerName" placeholder="Your Name" required />
          <input type="text" name="address" placeholder="Delivery Address" required />
          <input type="tel" name="phone" placeholder="Phone" required />
          <input type="date" name="deliveryDate" required />
          <input type="number" name="quantity" placeholder="Quantity" required min="1" max="${product.quantity}" />
          <button type="submit">Buy</button>
        </form>
      `;
      const form = li.querySelector(".orderForm");

      form.addEventListener("submit", async e => {
        e.preventDefault();
        const formData = new FormData(form);
        const orderData = {
          buyerName: formData.get("buyerName"),
          address: formData.get("address"),
          phone: formData.get("phone"),
          deliveryDate: formData.get("deliveryDate"),
          quantity: parseInt(formData.get("quantity")),
          product: product._id
        };

        try {
          const res = await fetch("http://localhost:5000/api/products/add", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}` // ✅
            },
            body: JSON.stringify(orderData)
          });

          const data = await res.json();
          if (res.ok) {
            alert("Order placed successfully!");
            window.location.reload();
          } else {
            alert(data.message || "Order failed.");
          }
        } catch (err) {
          console.error(err);
          alert("Order request error.");
        }
      });

      productList.appendChild(li);
    });
  } catch (err) {
    console.error(err);
    alert("Could not load products.");
  }
});

  </script>
</body>
</html>
